<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.javanos.project.report.model.dao.ReportDAO">
    <resultMap type="com.javanos.project.report.model.dto.ReportDTO" id="reportResultMap">
        <id property="reportNo" column="REPORT_NO"/>
        <result property="reportReason" column="REPORT_REASON"/>
        <result property="reportDate" column="REPORT_DATE"/>
        <result property="reportStatus" column="REPORT_STATUS"/>
        <association property="reportUser" javaType="com.javanos.project.user.model.dto.UserDTO">
            <id property="userNo" column="REPORT_USER_NO"/>
            <result property="userId" column="REPORT_USER_ID"/>
        </association>
        <association property="reportedUser" javaType="com.javanos.project.user.model.dto.UserDTO">
            <id property="userNo" column="REPORTED_USER_NO"/>
            <result property="userId" column="REPORTED_USER_ID"/>
        </association>
    </resultMap>

<select id="selectAllReports" resultMap="reportResultMap">
    SELECT 
        R.REPORT_NO, R.REPORT_REASON, R.REPORT_DATE, R.REPORT_STATUS, 
        R.REPORT_USER_NO, RU.USER_ID AS REPORT_USER_ID,
        R.REPORTED_USER_NO, RE.USER_ID AS REPORTED_USER_ID
    FROM 
        TBL_REPORT R
    LEFT JOIN TBL_USER RU ON R.REPORT_USER_NO = RU.USER_NO
    LEFT JOIN TBL_USER RE ON R.REPORTED_USER_NO = RE.USER_NO
    WHERE
        R.REPORT_STATUS IN ('Y', '계정정지완료')
</select>

    <insert id="insertReport" parameterType="com.javanos.project.report.model.dto.ReportDTO">
        INSERT INTO TBL_REPORT (REPORT_REASON, REPORT_DATE, REPORT_STATUS, REPORT_USER_NO, REPORTED_USER_NO)
        VALUES (#{reportReason}, NOW(), 'Y', #{reportUser.userNo}, #{reportedUser.userNo})
    </insert>

    <select id="selectReportByNo" parameterType="int" resultMap="reportResultMap">
        SELECT
            R.REPORT_NO, R.REPORT_REASON, R.REPORT_DATE, R.REPORT_STATUS, 
            R.REPORT_USER_NO, RU.USER_ID AS REPORT_USER_ID,
            R.REPORTED_USER_NO, RE.USER_ID AS REPORTED_USER_ID
        FROM 
            TBL_REPORT R
        LEFT JOIN TBL_USER RU ON R.REPORT_USER_NO = RU.USER_NO
        LEFT JOIN TBL_USER RE ON R.REPORTED_USER_NO = RE.USER_NO
        WHERE R.REPORT_NO = #{reportNo}
    </select>

    <select id="selectUserByUserId" parameterType="string" resultType="com.javanos.project.user.model.dto.UserDTO">
        SELECT 
            USER_NO, USER_ID, USER_PWD, USER_NAME, USER_NICKNAME, USER_EMAIL, USER_ROLE, USER_ENROLL_DATE, USER_STATUS, USER_STOP_DATE 
        FROM 
            TBL_USER 
        WHERE 
            USER_ID = #{userId}
    </select>
    
    <delete id="deleteReport" parameterType="int">
        DELETE FROM TBL_REPORT WHERE REPORT_NO = #{reportNo}
    </delete>
    
    <select id="selectUserNicknameByUserNo" parameterType="int" resultType="string">
        SELECT USER_NICKNAME
        FROM TBL_USER
        WHERE USER_NO = #{userNo}
    </select>
    
        <update id="updateReportStatus" parameterType="map">
        UPDATE TBL_REPORT
        SET REPORT_STATUS = #{reportStatus}
        WHERE REPORT_NO = #{reportNo}
    </update>

<update id="banUserByUserNo" parameterType="int">
    UPDATE TBL_USER
    SET USER_STATUS = 'N'
    WHERE USER_NO = #{userNo}
</update>
</mapper>